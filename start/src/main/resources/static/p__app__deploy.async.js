"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[544],{6294:function(Je,O,n){n.r(O),n.d(O,{default:function(){return ye}});var ue=n(77117),E=n.n(ue),ie=n(28152),p=n.n(ie),r=n(93236),oe=n(30189),de=n(25556),f=n(67801),w=n(93034),ce=n(69931),z=n(98984),K=n(75427),W=n(95020),y=n(53330),k=n(18775),ve=n(23817),B=n(56425),pe=n(98704),I=n(31756),d=n(91753),$=n(51593),me=n(11333),he=n.n(me),fe=n(5726),D=n.n(fe),e=n(62086),De=function(i){var c=i.open,S=i.onClose,j=i.pipeKey,C=(0,r.useState)(""),v=p()(C,2),o=v[0],Z=v[1];return(0,r.useEffect)(function(){var u;if(c){var M=function(){var F="ws://".concat(window.location.host,"/api/ws/devops/").concat(j);u=new WebSocket(F),console.log("connect addr",F),u.onopen=function(){console.log("WebSocket connected")},u.onmessage=function(A){var Y=A.data;Z(function(R){return R+Y})},u.onclose=function(){console.log("WebSocket closed")}};M()}return function(){u&&u.close()}},[c]),(0,e.jsx)(B.Z,{title:"\u67E5\u770B\u53D1\u5E03\u65E5\u5FD7",width:1200,onClose:S,open:c,children:(0,e.jsx)("pre",{children:o})})},xe=De,T=de.Z.Paragraph,G=function(i){switch(i){case"AWAIT_APPROVAL":return"\u5BA1\u6279\u4E2D";case"READY":return"\u5F85\u53D1\u5E03";case"PENDING":return"\u53D1\u5E03\u4E2D";case"FINISHED":return"\u5DF2\u5B8C\u6210";case"FAILED":return"\u53D1\u5E03\u5931\u8D25";case"CLOSED":return"\u5DF2\u5173\u95ED";default:return"\u672A\u77E5\u72B6\u6001"}},ge=function(i){switch(i){case"PENDING":return"\u5BA1\u6279\u4E2D";case"APPROVED":return"\u5DF2\u540C\u610F";case"AUTO_APPROVED":return"\u514D\u6279\u901A\u8FC7";case"REPEALED":return"\u5DF2\u64A4\u9500";case"REJECTED":return"\u5DF2\u9A73\u56DE";default:return"\u672A\u77E5\u72B6\u6001"}},Ee=function(i){var c,S,j,C,v=i.dispatch,o=i.appDetail,Z=i.releases,u=i.appEnv,M=(0,$.useParams)(),x=M.id,F=(0,r.useState)(!1),A=p()(F,2),Y=A[0],R=A[1],Se=(0,r.useState)(o==null||(c=o.appEnvList)===null||c===void 0||(c=c[0])===null||c===void 0?void 0:c.envId),U=p()(Se,2),m=U[0],J=U[1],je=(0,r.useState)({pageNo:1,pageSize:10}),X=p()(je,2),V=X[0],Ce=X[1],Ie=(0,r.useState)(!1),Q=p()(Ie,2),Ze=Q[0],q=Q[1],b=(0,r.useRef)(null),Fe=(0,r.useState)(null),_=p()(Fe,2),P=_[0],ee=_[1],Ae=(0,r.useState)(!1),te=p()(Ae,2),Ye=te[0],L=te[1],Re=(0,r.useState)(null),ne=p()(Re,2),s=ne[0],Ve=ne[1],Pe=(0,r.useState)(!1),ae=p()(Pe,2),we=ae[0],le=ae[1],Be=(0,r.useState)(""),se=p()(Be,2),Te=se[0],Me=se[1],be=f.Z.useForm(),Le=p()(be,1),Ne=Le[0],He=[{title:"\u53D1\u5E03\u5355\u53F7",dataIndex:"releaseNo",key:"releaseNo",render:function(l,a){return(0,e.jsx)(T,{copyable:{tooltips:["\u70B9\u51FB\u590D\u5236","\u590D\u5236\u6210\u529F"]},style:{display:"inline"},children:a==null?void 0:a.releaseNo})}},{title:"\u9884\u8BA1\u53D1\u5E03\u65F6\u95F4",dataIndex:"releaseDate",key:"releaseDate",render:function(l,a){return(0,e.jsx)("div",{children:D()(a==null?void 0:a.releaseDate).format("YYYY-MM-DD HH:mm:ss")})}},{title:"\u53D1\u5E03\u5206\u652F",dataIndex:"releaseBranch",key:"releaseBranch"},{title:"\u53D1\u5E03\u7248\u672C",dataIndex:"releaseVersion",key:"releaseVersion"},{title:"\u521B\u5EFA\u65F6\u95F4",dataIndex:"gmtCreate",key:"gmtCreate",render:function(l,a){return(0,e.jsx)("div",{children:D()(a==null?void 0:a.gmtCreate).format("YYYY-MM-DD HH:mm:ss")})}},{title:"\u66F4\u65B0\u65F6\u95F4",dataIndex:"gmtModified",key:"gmtModified",render:function(l,a){return(0,e.jsx)("div",{children:D()(a==null?void 0:a.gmtModified).format("YYYY-MM-DD HH:mm:ss")})}},{title:"\u53D1\u5E03\u72B6\u6001",dataIndex:"releaseStatus",key:"releaseStatus",render:function(l,a){var H=G(a.releaseStatus);return H}},{title:"\u64CD\u4F5C",key:"action",render:function(l,a){return(0,e.jsxs)(w.Z,{size:"middle",children:[(0,e.jsx)("a",{onClick:function(){return ze(a)},children:"\u67E5\u770B"}),a.releaseStatus!=="PENDING"&&(0,e.jsx)("a",{onClick:function(){return Oe(a)},children:"\u5173\u95ED"})]})}}],Oe=function(l){ce.Z.confirm({title:"\u786E\u8BA4\u5173\u95ED",content:"\u786E\u5B9A\u8981\u5173\u95ED\u5BA1\u6279\u5355\u5417\uFF1F",onOk:function(){v({type:"release/close",payload:{releaseId:l.releaseId}}),N()}})},ze=function(l){Ve(l),L(!0)},N=(0,r.useCallback)(function(){if(m){console.log("\u5F00\u59CB\u8C03\u7528\u73AF\u5883\u4FE1\u606F",m),v({type:"app/getAppEnv",payload:{envId:m}}),v({type:"release/pageRelease",payload:E()(E()({},V),{},{appId:x,envId:m})});var t=u==null?void 0:u.deployStatus;(t==null?void 0:t.toString())==="1"?(q(!0),b.current=setInterval(function(){v({type:"app/getAppEnv",payload:{envId:m}})},3e3)):q(!1)}},[v,V,x,m,u==null?void 0:u.deployStatus]);(0,r.useEffect)(function(){v({type:"app/getAppDetail",payload:{id:x}})},[v,x]),(0,r.useEffect)(function(){N()},[N]),console.log("appEnv",u),(0,r.useEffect)(function(){if(!m&&o!==null&&o!==void 0&&o.appEnvList){var t;J(o==null||(t=o.appEnvList)===null||t===void 0?void 0:t[0].envId)}},[m,o]),(0,r.useEffect)(function(){return function(){b.current!==null&&clearInterval(b.current)}},[]);var Ke={type:"radio",onChange:function(l,a){ee(a[0])}},We=function(){if(!P){z.ZP.warning("\u8BF7\u9009\u62E9\u7B26\u5408\u6761\u4EF6\u7684\u53D8\u66F4\u5355");return}if(P.releaseStatus==="CLOSED"){z.ZP.warning("\u5DF2\u5173\u95ED\u7684\u53D8\u66F4\u5355\u4E0D\u5141\u8BB8\u53D1\u5E03");return}v({type:"release/deploy",payload:{releaseId:P.releaseId}}),ee(null)},re=function(){R(!Y)},ke=function(l){J(l),console.log("env change",l)},$e=function(l,a){Ce({pageNo:l,pageSize:a||10})},Ge=function(l){console.log("Form Values:",l),v({type:"release/createRelease",payload:E()(E()({},l),{},{appId:x,envId:m})}),console.log("dispatch",v),R(!1)},Ue=function(l){console.log("pipeKey",l),Me(l),le(!0)},h=(0,r.useMemo)(function(){return u&&u.progress?JSON.parse(u.progress):null},[u]);return(0,e.jsxs)(oe._z,{title:"\u5E94\u7528\u4E2D\u5FC3",extra:[(0,e.jsx)(K.Z,{value:m,onChange:ke,style:{width:120},children:o==null||(S=o.appEnvList)===null||S===void 0?void 0:S.map(function(t){return(0,e.jsx)(K.Z.Option,{value:t.envId,children:t.envName},t.envId)})},"environment")],children:[(0,e.jsxs)(w.Z,{size:"middle",direction:"vertical",style:{width:"100%"},children:[(0,e.jsx)(W.Z,{title:"\u53D1\u5E03\u6D41\u6C34\u7EBF",extra:(0,e.jsxs)("div",{children:[(h==null?void 0:h.pipeKey)&&(0,e.jsx)(y.Z,{onClick:function(){return Ue(h==null?void 0:h.pipeKey)},children:"\u67E5\u770B\u53D1\u5E03\u65E5\u5FD7"}),(0,e.jsx)(y.Z,{onClick:We,disabled:Ze||!P,children:"\u7ACB\u5373\u53D1\u5E03"},"release")]}),children:h&&(0,e.jsx)(k.Z,{current:h.current,status:h.status,size:"small",children:h.steps.map(function(t,l){return(0,e.jsx)(k.Z.Step,{title:t.title,description:t.description==="AWAIT_EXECUTE"?(0,e.jsx)("div",{children:"\u5F85\u6267\u884C"}):t.description==="EXECUTED"?(0,e.jsxs)("div",{children:["\u5DF2\u6267\u884C",(0,e.jsx)("br",{}),"\u8017\u65F6:",t.cost,"\u79D2"]}):t.description},l)})})}),(0,e.jsx)(W.Z,{title:"\u53D1\u5E03\u5355",extra:(0,e.jsx)("div",{children:(0,e.jsx)(y.Z,{onClick:re,children:"\u6DFB\u52A0\u53D1\u5E03\u5355"})}),children:(0,e.jsx)(ve.Z,{columns:He,dataSource:Z.list,rowKey:"releaseId",rowSelection:E()({},Ke),pagination:{total:Z.total,current:V.pageNo,pageSize:V.pageSize,onChange:$e}})})]}),(0,e.jsx)(B.Z,{title:"\u6DFB\u52A0\u53D1\u5E03\u5355",width:600,onClose:re,open:Y,children:(0,e.jsxs)(f.Z,{layout:"vertical",form:Ne,initialValues:{releaseDate:"",releaseBranch:"",docAddress:"",appId:x,envId:m},onFinish:function(l){return Ge(l)},children:[(0,e.jsx)(f.Z.Item,{label:"\u9884\u8BA1\u53D1\u5E03\u65E5\u671F",name:"releaseDate",children:(0,e.jsx)(pe.Z,{showTime:!0,defaultValue:he()()})}),(0,e.jsx)(f.Z.Item,{label:"\u53D1\u5E03\u5206\u652F",name:"releaseBranch",rules:[{required:!0,message:"\u8BF7\u8F93\u5165\u53D1\u5E03\u5206\u652F"}],children:(0,e.jsx)(I.Z,{})}),(0,e.jsx)(f.Z.Item,{label:"\u53D1\u5E03\u7248\u672C",name:"releaseVersion",rules:[{required:!0,message:"\u8BF7\u8F93\u5165\u53D1\u5E03\u7248\u672C"}],children:(0,e.jsx)(I.Z,{})}),(0,e.jsx)(f.Z.Item,{label:"\u6587\u6863\u5730\u5740",name:"docAddress",rules:[{required:!0,message:"\u8BF7\u8F93\u5165\u6587\u6863\u5730\u5740"}],children:(0,e.jsx)(I.Z,{})}),(0,e.jsx)(f.Z.Item,{label:"\u5907\u6CE8",name:"comment",rules:[{required:!0,message:"\u8BF7\u8F93\u5165\u53D1\u5E03\u5206\u652F"}],children:(0,e.jsx)(I.Z.TextArea,{})}),(0,e.jsx)(y.Z,{type:"primary",htmlType:"submit",children:"\u63D0\u4EA4"})]})}),(0,e.jsx)(B.Z,{title:"\u53D1\u5E03\u5355\u8BE6\u60C5",width:600,onClose:function(){return L(!1)},open:Ye,children:s&&(0,e.jsxs)(w.Z,{style:{width:"100%"},direction:"vertical",size:"small",children:[(0,e.jsxs)(d.Z,{labelStyle:{width:"160px"},column:1,bordered:!0,title:"\u57FA\u7840\u4FE1\u606F",children:[(0,e.jsx)(d.Z.Item,{label:"\u53D1\u5E03\u5355\u53F7",children:(0,e.jsx)(T,{copyable:{tooltips:["\u70B9\u51FB\u590D\u5236","\u590D\u5236\u6210\u529F"]},style:{display:"inline"},children:s.releaseNo})}),(0,e.jsx)(d.Z.Item,{label:"\u9884\u8BA1\u53D1\u5E03\u65F6\u95F4",children:D()(s==null?void 0:s.releaseDate).format("YYYY-MM-DD HH:mm:ss")}),(0,e.jsx)(d.Z.Item,{label:"\u53D1\u5E03\u5206\u652F",children:s.releaseBranch}),(0,e.jsx)(d.Z.Item,{label:"\u53D1\u5E03\u7248\u672C",children:s.releaseVersion}),(0,e.jsx)(d.Z.Item,{label:"\u521B\u5EFA\u65F6\u95F4",children:D()(s==null?void 0:s.gmtCreate).format("YYYY-MM-DD HH:mm:ss")}),(0,e.jsx)(d.Z.Item,{label:"\u66F4\u65B0\u65F6\u95F4",children:D()(s==null?void 0:s.gmtModified).format("YYYY-MM-DD HH:mm:ss")}),(0,e.jsx)(d.Z.Item,{label:"\u53D1\u5E03\u72B6\u6001",children:G(s.releaseStatus)})]}),s.approvalDTO&&(0,e.jsxs)(d.Z,{labelStyle:{width:"160px"},column:1,bordered:!0,title:"\u5BA1\u6279\u5355\u8BE6\u60C5",children:[(0,e.jsx)(d.Z.Item,{label:"\u53D1\u5E03\u5355\u53F7",children:(0,e.jsx)(T,{copyable:{tooltips:["\u70B9\u51FB\u590D\u5236","\u590D\u5236\u6210\u529F"]},style:{display:"inline"},children:s.approvalDTO.approvalId})}),(0,e.jsx)(d.Z.Item,{label:"\u53D1\u8D77\u65F6\u95F4",children:D()((j=s.approvalDTO)===null||j===void 0?void 0:j.changeDate).format("YYYY-MM-DD HH:mm:ss")}),(0,e.jsx)(d.Z.Item,{label:"\u6587\u6863\u5730\u5740",children:(C=s.approvalDTO)===null||C===void 0?void 0:C.docAddress}),(0,e.jsx)(d.Z.Item,{label:"\u5BA1\u6279\u72B6\u6001",children:ge(s.approvalDTO.approvalStatus)})]}),(0,e.jsx)(y.Z,{onClick:function(){return L(!1)},style:{marginTop:16},children:"\u5173\u95ED"})]})}),(0,e.jsx)(xe,{open:we,onClose:function(){le(!1)},pipeKey:Te})]})},ye=(0,$.connect)(function(g){var i=g.app,c=g.release;return{appDetail:i.appDetail,appEnv:i.appEnv,releases:{total:c.releases.total,list:c.releases.list}}})(Ee)}}]);
